#!/usr/bin/env perl6

use lib "{%*ENV<HOME>}/.shared-modules";
use ShopifyGit;

sub MAIN(Str $branch-name-arg = "", Str :$remote = "origin") {
    my $head = run(<<git name-rev --name-only @>>, :out, :err).out.slurp(:close).chomp;

    my Str $branch-name;
    if $branch-name-arg eq "" {
        $branch-name = $head;
    } else {
        $branch-name = $branch-name-arg;
    }

    my $proc = run(<<git name-rev --name-only "{$branch-name}@\{u}">>, :out, :err);
    if $proc.exitcode == 0 {
        git(<<branch --delete --remotes "$remote/{$_}">>) for $proc.out.lines;
    }
    if $head eq $branch-name {
        git(<<checkout --detach>>);
    }
    git(<<branch --delete --force $branch-name>>);
    git(<<config --unset "remote.{$remote}.fetch">>, Qc<^\+refs/heads/{$branch-name}:>);
}
